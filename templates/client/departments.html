{% extends "base.html" %}
{% block content %}

{# â€”â€”â€” HERO â€”â€”â€” #}
<div class="hero welcome-hero mb-4 p-4">
  <div class="hero-inner d-flex align-items-stretch justify-content-between flex-wrap gap-3 w-100">

    <!-- SINISTRA -->
    <div class="welcome-left d-flex align-items-center gap-3">
      <div class="hero-logo-wrap">
        <img src="{{ url_for('static', filename='img/prova-3.png') }}" alt="Logo">
      </div>
      <div class="welcome-text d-flex flex-column justify-content-center">
        <div class="fw-bold display-6 lh-1 mb-1">Ciao, {{ current_user.display_name }} ðŸ‘‹</div>
        <div class="subtle">
          {% if current_user.role == 'employee' %}Profilo: Dipendente{% else %}Profilo: Negozio{% endif %}
        </div>
      </div>
    </div>

    <!-- DESTRA (desktop) -->
    <div class="welcome-right d-none d-lg-flex flex-column align-items-end justify-content-end ms-auto">
      <div class="kpi mb-2">
        <div class="value">{{ (total_selected|default(0)) }}</div>
        <div class="label">Prodotti compilati</div>
      </div>
      {% if current_user.role == 'employee' %}
      <a href="{{ url_for('client_review') }}"
         class="btn btn-primary btn-lg mt-1 {% if (total_selected|default(0)) == 0 %}disabled{% endif %}"
         {% if (total_selected|default(0)) == 0 %}aria-disabled="true" tabindex="-1"{% endif %}>
        Riepilogo &amp; Invia
      </a>
      {% endif %}
    </div>

  </div>
</div>

<h1 class="h4 mb-3">Reparti</h1>

{# â€”â€” RENDER DINAMICO DI TUTTE LE MACRO-AREE CONSENTITE â€”â€” #}
<div class="row g-4">
  {% for a in areas %}
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h5 m-0">{{ a.area|replace('_',' ')|title }}</h2>
          {% if a.code_required and not a.unlocked %}
            <span class="badge bg-warning text-dark">Protetta</span>
          {% endif %}
        </div>

        {% if a.code_required and not a.unlocked %}
          <form method="post" action="{{ url_for('client_macro_unlock') }}" class="d-flex gap-2">
            <input type="hidden" name="area" value="{{ a.area }}">
            <input type="password" class="form-control" name="code" placeholder="Inserisci codice {{ a.area|replace('_',' ')|title }}" required>
            <button class="btn btn-primary" type="submit">Sblocca</button>
          </form>
        {% else %}
          {% if a.deps|length == 0 %}
            <div class="text-muted">Nessun reparto in questa area.</div>
          {% else %}
            <div class="list-group">
              {% for d in a.deps %}
                {% set compiled = counts.get(d.id, 0)|int %}
                <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center dep-tile {{ 'is-done' if compiled>0 else '' }}"
                   href="{{ url_for('client_products', dep_id=d.id) }}">
                  <div class="d-flex align-items-center gap-2">
                    <span class="status-dot {{ 'done' if compiled>0 else 'todo' }}"></span>
                    <span>{{ d.name }}</span>
                  </div>
                  <span class="badge count-badge {{ 'bg-success text-white' if compiled>0 else 'bg-light text-dark' }}">
                    {{ compiled }}
                  </span>
                </a>
              {% endfor %}
            </div>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{# CTA MOBILE in fondo alla pagina #}
{% if current_user.role == 'employee' %}
  <div class="mobile-cta d-lg-none mt-4">
    <a href="{{ url_for('client_review') }}"
       class="btn btn-primary btn-lg w-100 {% if (total_selected|default(0)) == 0 %}disabled{% endif %}"
       {% if (total_selected|default(0)) == 0 %}aria-disabled="true" tabindex="-1"{% endif %}>
      Riepilogo &amp; Invia
    </a>
  </div>
{% endif %}

<style>
/* â€”â€”â€” LOGO & HERO â€”â€”â€” */
.welcome-hero{ min-height:110px; }
.hero-logo-wrap{
  width: clamp(120px, 20vw, 250px);
  height: clamp(120px, 20vw, 250px);
}
.hero-logo-wrap img{ width:100%; height:100%; object-fit:contain; }
.welcome-text{ min-height:96px; }

/* KPI centrato rispetto alla label (desktop) */
.kpi{
  display:grid; justify-items:center; align-items:center; gap:.2rem; width:max-content; margin:0;
}
.kpi .value{ font-weight:800; line-height:1; font-size: clamp(1.75rem, 1.2rem + 2vw, 3rem); }
.kpi .label{ font-size:.95rem; opacity:.85; }

/* Desktop: bottone e KPI in basso a destra */
.welcome-right{
  min-height:140px;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
  align-items:flex-end;
}

/* â€”â€”â€” TILE FORNITORI: stato completato â€”â€”â€” */
.dep-tile{
  border-radius: 12px;
  transition: border-color .15s ease, background .15s ease, box-shadow .15s ease;
}
.dep-tile.is-done{
  border-color: rgba(16,185,129,.35) !important;
  background: linear-gradient(180deg,#f6fffb,#ffffff);
  box-shadow: 0 4px 14px rgba(16,185,129,.10);
}
.status-dot{
  width: 10px; height: 10px; border-radius: 50%;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
}
.status-dot.done{ background:#10b981; }
.status-dot.todo{ background:#e5e7eb; }
.count-badge{ font-weight:700; min-width:2.2em; text-align:center; }
.dep-tile:hover{ background:#f8fbff; border-color:#dbe3f5; }

/* â€”â€”â€” MOBILE â€”â€”â€” */
@media (max-width: 768px){
  .hero-inner{ flex-direction:column; align-items:center; text-align:center; }
  .welcome-left{ flex-direction:column; align-items:center; gap:10px; }
  .hero-logo-wrap{ margin:0 auto; width:200px; height:200px; }
  .welcome-text{ min-height:auto; }
  .welcome-right{ display:none !important; }
  .mobile-cta{ position:static; }
}
</style>

{% endblock %}