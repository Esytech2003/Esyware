{% extends "base.html" %}
{% block content %}

{# ‚Äî‚Äî‚Äî HERO ‚Äî‚Äî‚Äî #}
<div class="hero welcome-hero mb-4 p-4">
  <div class="hero-inner d-flex align-items-stretch justify-content-between flex-wrap gap-3 w-100">

    <!-- SINISTRA -->
    <div class="welcome-left d-flex align-items-center gap-3">
      <div class="hero-logo-wrap">
        <img src="{{ url_for('static', filename='img/prova-3.png') }}" alt="Logo">
      </div>
      <div class="welcome-text d-flex flex-column justify-content-center">
        <div class="fw-bold display-6 lh-1 mb-1">Ciao, {{ current_user.display_name }} üëã</div>
        <div class="subtle">
          {% if current_user.role == 'employee' %}Profilo: Dipendente{% else %}Profilo: Negozio{% endif %}
        </div>
      </div>
    </div>

    <!-- DESTRA (desktop) -->
    <div class="welcome-right d-none d-lg-flex flex-column align-items-end justify-content-end ms-auto">
      <div class="kpi mb-2">
        <div class="value">{{ (total_selected|default(0)) }}</div>
        <div class="label">Prodotti compilati</div>
      </div>
      {% if current_user.role == 'employee' %}
      <a href="{{ url_for('client_review') }}"
         class="btn btn-primary btn-lg mt-1 {% if (total_selected|default(0)) == 0 %}disabled{% endif %}"
         {% if (total_selected|default(0)) == 0 %}aria-disabled="true" tabindex="-1"{% endif %}>
        Riepilogo &amp; Invia
      </a>
      {% endif %}
    </div>

  </div>
</div>



<h1 class="h4 mb-3">Reparti</h1>

{# ‚Äî‚Äî RENDER DINAMICO DI TUTTE LE MACRO-AREE CONSENTITE ‚Äî‚Äî #}
<div class="row g-4">
  {% for a in areas %}
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h5 m-0">{{ a.area|replace('_',' ')|title }}</h2>
          {% if a.code_required and not a.unlocked %}
            <span class="badge bg-warning text-dark">Protetta</span>
          {% endif %}
        </div>

        {% if a.code_required and not a.unlocked %}
          <form method="post" action="{{ url_for('client_macro_unlock') }}" class="d-flex gap-2">
            <input type="hidden" name="area" value="{{ a.area }}">
            <input type="password" class="form-control" name="code" placeholder="Inserisci codice {{ a.area|replace('_',' ')|title }}" required>
            <button class="btn btn-primary" type="submit">Sblocca</button>
          </form>
        {% else %}
          {% if a.deps|length == 0 %}
            <div class="text-muted">Nessun reparto in questa area.</div>
          {% else %}
            <div class="list-group">
              {% for d in a.deps %}
              {% set compiled = counts.get(d.id, 0)|int %}
              {% set zero_complete = all_zero_map.get(d.id, False) %}
              {% set is_done = compiled > 0 or zero_complete %}

              <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center dep-tile {{ 'is-done' if is_done else '' }}"
                href="{{ url_for('client_products', dep_id=d.id) }}">
                <div class="d-flex align-items-center gap-2">
                  <span class="status-dot {{ 'done' if is_done else 'todo' }}"></span>
                  <span>{{ d.name }}</span>
                </div>
                <span class="badge count-badge {{ 'bg-success text-white' if is_done else 'bg-light text-dark' }}">
                  {{ compiled }}
                </span>
              </a>
            {% endfor %}
            </div>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{# CTA MOBILE in fondo alla pagina #}
{% if current_user.role == 'employee' %}
  <div class="mobile-cta d-lg-none mt-4">
    <a href="{{ url_for('client_review') }}"
       class="btn btn-primary btn-lg w-100 {% if (total_selected|default(0)) == 0 %}disabled{% endif %}"
       {% if (total_selected|default(0)) == 0 %}aria-disabled="true" tabindex="-1"{% endif %}>
      Riepilogo &amp; Invia
    </a>
  </div>
{% endif %}

{# ‚Äî‚Äî‚Äî ULTIMI RIEPILOGHI (in fondo) ‚Äî‚Äî‚Äî #}
{% if history and history|length > 0 %}
  <div class="card shadow-sm mb-4 last-history-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h5 m-0 section-title">Ultimi riepiloghi inviati</h2>
      </div>

      <div class="timeline">
        {% for h in history %}
          <div class="timeline-item position-relative">
            <div class="dot"></div>
            <div class="content">
              <div class="d-flex flex-wrap align-items-center gap-2">
                <div class="when fw-semibold">{{ h.dt | local_dt('%d/%m/%Y %H:%M') }}</div>
                <div class="sep">‚Ä¢</div>
                <div class="rows">{{ h.rows }} {{ 'riga' if h.rows==1 else 'righe' }}</div>
                {% if h.areas %}
                  <div class="sep">‚Ä¢</div>
                  <div class="areas d-flex flex-wrap gap-1">
                    {% for a in h.areas %}
                      <span class="badge area-badge">{{ a|replace('_',' ')|title }}</span>
                    {% endfor %}
                  </div>
                {% endif %}

                {# Desktop/tablet: bottone inline a destra #}
                <a class="btn btn-primary ms-auto btn-open d-none d-sm-inline-flex"
                   href="{{ url_for('client_sent_request_view', req_id=h.id) }}">
                  Apri
                </a>
              </div>

              {# Mobile: bottone piccolo in basso a destra #}
              <a class="btn btn-primary btn-open-mobile d-sm-none"
                 href="{{ url_for('client_sent_request_view', req_id=h.id) }}"
                 aria-label="Apri riepilogo">Apri</a>

              <a class="stretched-link"
                 href="{{ url_for('client_sent_request_view', req_id=h.id) }}"
                 aria-label="Apri riepilogo"></a>
            </div>
          </div>
        {% endfor %}
      </div>

      {% if history|length == 1 %}
        <div class="subtle small mt-2">Mostrato 1 riepilogo (non sono presenti invii precedenti).</div>
      {% endif %}
    </div>
  </div>
{% else %}
  <div class="card shadow-sm mb-4 last-history-card">
    <div class="card-body">
      <h2 class="h6 m-0 subtle">Nessun riepilogo inviato di recente.</h2>
    </div>
  </div>
{% endif %}


<style>
/* ‚Äî‚Äî‚Äî LOGO & HERO ‚Äî‚Äî‚Äî */
.welcome-hero{ min-height:110px; }
.hero-logo-wrap{
  width: clamp(120px, 20vw, 250px);
  height: clamp(120px, 20vw, 250px);
}
.hero-logo-wrap img{ width:100%; height:100%; object-fit:contain; }
.welcome-text{ min-height:96px; }

/* KPI centrato rispetto alla label (desktop) */
.kpi{
  display:grid; justify-items:center; align-items:center; gap:.2rem; width:max-content; margin:0;
}
.kpi .value{ font-weight:800; line-height:1; font-size: clamp(1.75rem, 1.2rem + 2vw, 3rem); }
.kpi .label{ font-size:.95rem; opacity:.85; }

/* Desktop: bottone e KPI in basso a destra */
.welcome-right{
  min-height:140px;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
  align-items:flex-end;
}

/* ‚Äî‚Äî‚Äî TILE FORNITORI: stato completato ‚Äî‚Äî‚Äî */
.dep-tile{
  border-radius: 12px;
  transition: border-color .15s ease, background .15s ease, box-shadow .15s ease;
}
.dep-tile.is-done{
  border-color: rgba(16,185,129,.35) !important;
  background: linear-gradient(180deg,#f6fffb,#ffffff);
  box-shadow: 0 4px 14px rgba(16,185,129,.10);
}
.status-dot{
  width: 10px; height: 10px; border-radius: 50%;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
}
.status-dot.done{ background:#10b981; }
.status-dot.todo{ background:#e5e7eb; }
.count-badge{ font-weight:700; min-width:2.2em; text-align:center; }
.dep-tile:hover{ background:#f8fbff; border-color:#dbe3f5; }

/* ‚Äî‚Äî‚Äî MOBILE ‚Äî‚Äî‚Äî */
@media (max-width: 768px){
  .hero-inner{ flex-direction:column; align-items:center; text-align:center; }
  .welcome-left{ flex-direction:column; align-items:center; gap:10px; }
  .hero-logo-wrap{ margin:0 auto; width:200px; height:200px; }
  .welcome-text{ min-height:auto; }
  .welcome-right{ display:none !important; }
  .mobile-cta{ position:static; }
}


/* ‚Äî‚Äî Timeline in fondo ‚Äî‚Äî */
.last-history-card{ margin-top: 20px; }

/* Struttura timeline allineata al tema */
.timeline{ position:relative; padding-left: 14px; }
.timeline-item{ padding: 12px 0 12px 12px; border-left: 2px solid var(--border); position: relative;}
.timeline-item .dot{
  position:absolute; left:-6px; top: 18px;
  width:10px; height:10px; border-radius:50%;
  background: var(--brand);
  box-shadow: 0 0 0 2px #fff;
}
.timeline .sep{ color: var(--muted); }

/* linea orizzontale di separazione fra gli item */
.timeline-item:not(:last-child){
  border-bottom: 1px solid var(--border);
  padding-bottom: 14px;   /* spazio prima del divisore */
  margin-bottom: 10px;    /* spazio dopo il divisore */
}


/* Contenuto riga */
.timeline .content{ position:relative; padding-right: 0.5rem; }
.area-badge{
  background: #eaf7ff;               /* azzurro soft */
  color: var(--brand-ink);
  border: 1px solid #d7efff;
  font-weight: 700;
}

/* ‚Äî Bottoni ‚ÄúApri‚Äù con lo stesso stile blu dei CTA ‚Äî */
.btn-open{
  /* eredita il gradient da .btn-primary del tuo tema */
  padding-left: 1.1rem;
  padding-right: 1.1rem;
  font-weight: 700;
  border-radius: 12px;
  box-shadow: 0 6px 16px rgba(0,0,0,.08);
  transition: transform .08s ease, filter .12s ease;
}
.btn-open:hover{ transform: translateY(-1px); filter: brightness(1.03); }
@media (min-width: 576px){
  .btn-open{
    display: inline-flex;           /* abilita centering flex */
    align-items: center;            /* centro verticale */
    justify-content: center;        /* centro orizzontale */
    min-height: 44px;               /* altezza costante */
    min-width: 180px;               /* pi√π largo */
    text-align: center;             /* fallback */
  }
}

/* ‚Äî Mobile: bottone pi√π piccolo in basso a destra ‚Äî */
.btn-open-mobile{
  position:absolute;
  right: 6px;
  bottom: 8px;
  padding: .45rem .7rem;
  font-size: .9rem;
  font-weight: 700;
  border-radius: 12px;
  line-height: 1.1;
  box-shadow: 0 6px 16px rgba(0,0,0,.08);
}
@media (max-width: 575.98px){
  /* spazio sotto il testo per non sovrapporsi al bottone mobile */
  .timeline .content{ padding-bottom: 44px; }
}

/* Allineamenti e spaziature coerenti col tema */
.section-title{ font-weight: 700; letter-spacing: .2px; }
.subtle{ color: var(--muted); }

/* opzionale: rendi la linea un filo pi√π visibile */
@media (prefers-color-scheme: light){
  .timeline-item:not(:last-child){
    border-bottom-color: #dfe5ef;   /* leggermente pi√π marcata ma in palette */
  }
}
</style>

{% endblock %}