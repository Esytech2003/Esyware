{% extends "base.html" %}
{% block content %}
<div class="print-container">
  <div class="print-header">

    {# — reparti unici per l'intestazione — #}
    {% set ns = namespace(deps=[]) %}
    {% for blk in hierarchy %}
      {% for dep in blk.departments %}
        {% if dep.name not in ns.deps %}
          {% set _ = ns.deps.append(dep.name) %}
        {% endif %}
      {% endfor %}
    {% endfor %}

    <h1>
      Recap Piano #{{ plan.id }}
      {% if ns.deps|length %}
        <span class="dep-inline">— {{ ns.deps|sort|join(' · ') }}</span>
      {% endif %}
    </h1>

    <div class="subtle">
      Creato il {{ plan.created_at.strftime('%d/%m/%Y %H:%M') }}
      · Generato il {{ (gen_dt or plan.created_at).strftime('%d/%m/%Y %H:%M') }}
    </div>
    
      {{ plan.status|capitalize }}
    </div>
  </div>

  {% if hierarchy|length == 0 %}
    <div class="text-muted mt-4">Nessun prodotto da caricare.</div>
  {% endif %}

  {% set single_client = (hierarchy|length == 1) %}

  {% for blk in hierarchy %}
    <div class="client-block">
      {% if not single_client %}
        <h2 class="client-title">
          <i class="bi bi-shop me-1"></i>{{ blk.client.display_name if blk.client else '—' }}
        </h2>
      {% endif %}

      {% for dep in blk.departments %}
        <div class="dept-block">
          <table class="table-print">
            <colgroup>
              <col>                 {# colonna Prodotto #}
              <col class="qty-col"> {# colonna Quantità minima e destra #}
            </colgroup>
            <thead>
              <tr>
                <th>Prodotto</th>
                <th class="th-qty">Q.tà</th>
              </tr>
            </thead>
            <tbody>
              {% for row in dep.products %}
                <tr>
                  <td class="pdf-name">{{ row.product.name }}</td>
                  <td class="pdf-qty">
                    <span class="qty-val">{{ row.qty_in|fmt_qty }}</span>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endfor %}
    </div>
  {% endfor %}
</div>

<style>
:root{
  --qty-size: 1.42rem;  /* grandezza numeri quantità */
}

.print-container{ max-width:960px; margin:0 auto; }
@page { size:A4; margin:14mm 12mm 16mm 12mm; }
@media print{ .navbar,.btn,.alert,.toast-stack{ display:none!important; } body{ background:#fff!important; } }

/* header */
.print-header h1{ margin:0 0 .25rem 0; line-height:1.15; }
.dep-inline{ font-size:1.1em; font-weight:800; margin-left:.45rem; white-space:pre-wrap; }

/* blocchi */
.client-block{ page-break-inside:avoid; margin-top:16px; }
.client-title{
  font-size:1.05rem; font-weight:700; margin:0 0 .35rem 0;
  padding:.3rem .55rem; border-radius:12px;
  background:#f7fbff; border:1px solid var(--border);
}
.dept-block{ margin: 6px 0 12px 0; page-break-inside:avoid; }

/* tabella stile identico all’altro PDF */
.table-print{ width:100%; border-collapse:collapse; table-layout:auto; }
.table-print thead th{
  font-weight:700;           /* grassetto visibile in PDF */
  font-size:1.05rem;
  color:#000;
  border-bottom:1.5px solid #000;
  padding:.40rem .22rem;
}
.th-qty{ text-align:right; }

.qty-col{
  width:1%;                 /* colonna minima */
  white-space:nowrap;
}

.table-print tbody td{
  border-bottom:1px solid var(--border);
  padding:.26rem .22rem;
  line-height:1.2;
}
.table-print tr:last-child td{ border-bottom:none; }

.pdf-name{ padding-right:6px; }
.pdf-qty{ padding-left:6px; text-align:right; }
.qty-val{
  font-weight:900;
  font-size: var(--qty-size);
  line-height:1;
  font-variant-numeric: tabular-nums;
  color:#000;
}

/* badge colori fallback */
.bg-success{ background:#198754!important; color:#fff!important; }
.bg-secondary{ background:#6c757d!important; color:#fff!important; }
</style>
{% endblock %}